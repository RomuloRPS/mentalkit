<ion-menu mode="ios" menuId="filters" side="end" type="push" contentId="main">
  <ion-header>
    <ion-toolbar color="primary">
      <ion-title>Filtros</ion-title>
    </ion-toolbar>
  </ion-header>
  <ion-content>
    <ion-list>
      <div style="border-bottom: 1px solid gray;">
        <app-ev-select  class="border-b-2" [value]="menuFilters.category" iconColor="tertiary" showField="name" placeholder="Categoria"
        (valueChange)="filter($event)" [(valueId)]="selectedCategory" inputName='Roles' [baseService]="categoryService"
        #roleSelect></app-ev-select>
      </div>
      <!-- <ion-item lines="none" class="rounded-lg">
        <ion-icon slot="start" color="tertiary" name="calendar-outline"></ion-icon>
        <ion-label>Data: </ion-label>
        <ion-datetime (ngModelChange)="filter($event)" [(ngModel)]="menuFilters.date" cancelText="Cancelar" doneText="Ok" displayFormat="DD/MM/YYYY"></ion-datetime>
      </ion-item> -->
    </ion-list>
    <ion-row>
      <ion-col>
        <ion-button (click)="clearFilters()" color="primary" fill="outline" expand="block">Limpar</ion-button>
      </ion-col>
      <ion-col>
        <ion-button (click)="filter($event)" color="primary" expand="block">Filtrar</ion-button>
      </ion-col>
    </ion-row>
  </ion-content>
  <ion-footer>
  </ion-footer>
</ion-menu>

<ion-header class="ion-no-border">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>

    <ion-buttons *ngIf="!isSearchable" slot="end">
      <ion-button (click)="changeSearch()">
        <ion-icon name="search-outline"> </ion-icon>
      </ion-button>
    </ion-buttons>

    <ion-title *ngIf="!isSearchable">Despesas avulsas</ion-title>

    <ion-searchbar (ionBlur)="checkBlur()" #search [hidden]="!isSearchable" color="light" [(ngModel)]="searchTerm"
      (ionChange)="searchTask()" placeholder="{{'INPUT_SEARCH_PLACEHOLDER' | translate}}"></ion-searchbar>
  </ion-toolbar>


  <ion-toolbar class="text-center" color="primary">
    <ion-buttons *ngIf="selecteds.length === 0" slot="start">
      <ion-button [disabled]="loading" (click)="doRefresh()">
        <ion-icon name="refresh"></ion-icon>
      </ion-button>
    </ion-buttons>

    <ion-buttons *ngIf="selecteds.length >= 1"  slot="start">
      <ion-button (click)="deleteUsers()" >
        <ion-icon name="trash"></ion-icon>
      </ion-button>
    </ion-buttons>
    <!-- <ng-container *ngIf="!loadingFirstTime">
      <ion-label class="font-bold">{{menuFilters.date | dateTimeFormat: 'dd/MM/yyyy'}}</ion-label>
    </ng-container> -->

    <ng-container *ngIf="loadingFirstTime">
      <ion-label *ngIf="selecteds.length == 0" class="font-bold">Carregando...</ion-label>
    </ng-container>
    <ion-buttons *ngIf="selecteds.length >= 1"  slot="end">
      <ion-button (click)="clearSelect()">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </ion-buttons>

    <ion-buttons *ngIf="selecteds.length === 0" slot="end">
      <ion-button (click)="openMenu()">
        <ion-icon size="large" name="filter-outline">
        </ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>


<ion-content id="main" color="light">
  <ion-progress-bar color="dark" *ngIf="loading" type="indeterminate"></ion-progress-bar>

  <ion-refresher [disabled]="loading" id="refresher" #refresher (ionRefresh)="refresh($event)" color="light" slot="fixed">
    <ion-refresher-content color="light" pullingIcon="chevron-down-outline" pullingText="Puxe para atualizar"
      refreshingSpinner="crescent" refreshingText="Carregando...">
    </ion-refresher-content>
  </ion-refresher>

  <ng-container *ngIf="!loadingFirstTime">
    <ng-container *ngFor="let expense of expenses">
      <ion-card  [color]="getCardColor(expense)" (click)="trySelect(expense)" class="relative card-no-border card-no-margin">
        <ev-long-press (onPressing)="triggerLongPress(expense)">
            <ion-item [color]="getCardColor(expense)"  lines="none">
              <ion-thumbnail size="large" slot="start">
                <img *ngIf="expense.getRelation('avatar')?.getAttribute('token')" [src]="expense.getRelation('avatar')?.getAttribute('token') | attachmentToken">
                <ion-icon color="primary" class="text-5xl"  *ngIf="!expense.getRelation('avatar')?.getAttribute('token')" src="/assets/fontawesome/solid/image.svg"></ion-icon>
              </ion-thumbnail>
        
              <ion-label class="text-xs ">
                <p style="font-size: 13px;" class="mt-2 w-12/12">
                  <span class="font-bold text-base" style="font-size: 15px;">{{expense.getAttribute('name')}}</span>
                </p>
                <p style="font-size: 13px;" class="mt-2 w-12/12">
                  <span class="font-bold text-base" style="font-size: 15px;">{{expense.getAttribute('provider')}}</span>
                </p>
                <p style="font-size: 13px;" class="ml-1 mt-2">
                  <strong>{{expense.getRelation('category')?.getAttribute('name')}}</strong>
                </p>
        
                <p style="font-size: 13px;" class="ml-1 mt-2">
                   <span>{{expense.getAttribute('issue_date') | dateTimeFormat: 'dd/MM/yyyy'}}</span>
                </p>

                <p style="font-size: 13px;" class="mt-2">
                  <ion-badge class="mt-2" color="warning">
                    <ion-label>{{expense.getAttribute('value') | currency:'COP ':true }}</ion-label>
                  </ion-badge>
               </p>
              </ion-label>

              <ion-buttons  slot="end">
                <ion-button [disabled]="expense.selected" color="primary">
                  <ion-icon name="chevron-forward-outline"></ion-icon>
                </ion-button>
              </ion-buttons>
            </ion-item>
        </ev-long-press>
      </ion-card>
    </ng-container>
  </ng-container>

  <ion-card *ngIf="expenses.length == 0 && !this.loading">
    <ion-card-content>
      <div class="text-center">
        <ion-img class="h-20" src="../../assets/fontawesome/solid/wallet.svg"></ion-img>
        <ion-text color="dark" class="mt-4">
          <p class="mt-4">
            <strong class="text-xl mt-4">Nenhuma despesa encontrada!</strong>
          </p>
        </ion-text>
      </div>
    </ion-card-content>
  </ion-card>

  <ion-infinite-scroll id="infiniteScroll" #infiniteScroll threshold="100px" (ionInfinite)="loadMoreData($event)">
    <ion-infinite-scroll-content loadingSpinner="bubbles" >
    </ion-infinite-scroll-content>
  </ion-infinite-scroll>

</ion-content>

<ion-fab *ngIf="selecteds.length > 0" (click)="openOptions($event)" vertical="bottom" horizontal="end" slot="fixed">
  <ion-fab-button  color="secondary">
    <ion-icon name="ellipsis-horizontal-outline"></ion-icon>
  </ion-fab-button>
</ion-fab>

<ion-fab *ngIf="selecteds.length == 0" (click)="toExpenseCreate()" vertical="bottom" horizontal="end" slot="fixed">
  <ion-fab-button  color="secondary">
    <ion-icon name="add"></ion-icon>
  </ion-fab-button>
</ion-fab>
